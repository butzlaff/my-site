{"ast":null,"code":"'use strict'; // connection mixins\n// implementation of http://dev.mysql.com/doc/internals/en/compression.html\n\nconst zlib = require('zlib');\n\nconst PacketParser = require('./packet_parser.js');\n\nfunction handleCompressedPacket(packet) {\n  // eslint-disable-next-line consistent-this, no-invalid-this\n  const connection = this;\n  const deflatedLength = packet.readInt24();\n  const body = packet.readBuffer();\n\n  if (deflatedLength !== 0) {\n    connection.inflateQueue.push(task => {\n      zlib.inflate(body, (err, data) => {\n        if (err) {\n          connection._handleNetworkError(err);\n\n          return;\n        }\n\n        connection._bumpCompressedSequenceId(packet.numPackets);\n\n        connection._inflatedPacketsParser.execute(data);\n\n        task.done();\n      });\n    });\n  } else {\n    connection.inflateQueue.push(task => {\n      connection._bumpCompressedSequenceId(packet.numPackets);\n\n      connection._inflatedPacketsParser.execute(body);\n\n      task.done();\n    });\n  }\n}\n\nfunction writeCompressed(buffer) {\n  // http://dev.mysql.com/doc/internals/en/example-several-mysql-packets.html\n  // note: sending a MySQL Packet of the size 2^24−5 to 2^24−1 via compression\n  // leads to at least one extra compressed packet.\n  // (this is because \"length of the packet before compression\" need to fit\n  // into 3 byte unsigned int. \"length of the packet before compression\" includes\n  // 4 byte packet header, hence 2^24−5)\n  const MAX_COMPRESSED_LENGTH = 16777210;\n  let start;\n\n  if (buffer.length > MAX_COMPRESSED_LENGTH) {\n    for (start = 0; start < buffer.length; start += MAX_COMPRESSED_LENGTH) {\n      writeCompressed.call( // eslint-disable-next-line no-invalid-this\n      this, buffer.slice(start, start + MAX_COMPRESSED_LENGTH));\n    }\n\n    return;\n  } // eslint-disable-next-line no-invalid-this, consistent-this\n\n\n  const connection = this;\n  let packetLen = buffer.length;\n  const compressHeader = Buffer.allocUnsafe(7); // seqqueue is used here because zlib async execution is routed via thread pool\n  // internally and when we have multiple compressed packets arriving we need\n  // to assemble uncompressed result sequentially\n\n  (function (seqId) {\n    connection.deflateQueue.push(task => {\n      zlib.deflate(buffer, (err, compressed) => {\n        if (err) {\n          connection._handleFatalError(err);\n\n          return;\n        }\n\n        let compressedLength = compressed.length;\n\n        if (compressedLength < packetLen) {\n          compressHeader.writeUInt8(compressedLength & 0xff, 0);\n          compressHeader.writeUInt16LE(compressedLength >> 8, 1);\n          compressHeader.writeUInt8(seqId, 3);\n          compressHeader.writeUInt8(packetLen & 0xff, 4);\n          compressHeader.writeUInt16LE(packetLen >> 8, 5);\n          connection.writeUncompressed(compressHeader);\n          connection.writeUncompressed(compressed);\n        } else {\n          // http://dev.mysql.com/doc/internals/en/uncompressed-payload.html\n          // To send an uncompressed payload:\n          //   - set length of payload before compression to 0\n          //   - the compressed payload contains the uncompressed payload instead.\n          compressedLength = packetLen;\n          packetLen = 0;\n          compressHeader.writeUInt8(compressedLength & 0xff, 0);\n          compressHeader.writeUInt16LE(compressedLength >> 8, 1);\n          compressHeader.writeUInt8(seqId, 3);\n          compressHeader.writeUInt8(packetLen & 0xff, 4);\n          compressHeader.writeUInt16LE(packetLen >> 8, 5);\n          connection.writeUncompressed(compressHeader);\n          connection.writeUncompressed(buffer);\n        }\n\n        task.done();\n      });\n    });\n  })(connection.compressedSequenceId);\n\n  connection._bumpCompressedSequenceId(1);\n}\n\nfunction enableCompression(connection) {\n  connection._lastWrittenPacketId = 0;\n  connection._lastReceivedPacketId = 0;\n  connection._handleCompressedPacket = handleCompressedPacket;\n  connection._inflatedPacketsParser = new PacketParser(p => {\n    connection.handlePacket(p);\n  }, 4);\n  connection._inflatedPacketsParser._lastPacket = 0;\n  connection.packetParser = new PacketParser(packet => {\n    connection._handleCompressedPacket(packet);\n  }, 7);\n  connection.writeUncompressed = connection.write;\n  connection.write = writeCompressed;\n\n  const seqqueue = require('seq-queue');\n\n  connection.inflateQueue = seqqueue.createQueue();\n  connection.deflateQueue = seqqueue.createQueue();\n}\n\nmodule.exports = {\n  enableCompression: enableCompression\n};","map":{"version":3,"names":["zlib","require","PacketParser","handleCompressedPacket","packet","connection","deflatedLength","readInt24","body","readBuffer","inflateQueue","push","task","inflate","err","data","_handleNetworkError","_bumpCompressedSequenceId","numPackets","_inflatedPacketsParser","execute","done","writeCompressed","buffer","MAX_COMPRESSED_LENGTH","start","length","call","slice","packetLen","compressHeader","Buffer","allocUnsafe","seqId","deflateQueue","deflate","compressed","_handleFatalError","compressedLength","writeUInt8","writeUInt16LE","writeUncompressed","compressedSequenceId","enableCompression","_lastWrittenPacketId","_lastReceivedPacketId","_handleCompressedPacket","p","handlePacket","_lastPacket","packetParser","write","seqqueue","createQueue","module","exports"],"sources":["/home/emilio/Área de Trabalho/OneBitCode-aulas/REACT/site-react-login-live/react-controlledForms/node_modules/mysql2/lib/compressed_protocol.js"],"sourcesContent":["'use strict';\n\n// connection mixins\n// implementation of http://dev.mysql.com/doc/internals/en/compression.html\n\nconst zlib = require('zlib');\nconst PacketParser = require('./packet_parser.js');\n\nfunction handleCompressedPacket(packet) {\n  // eslint-disable-next-line consistent-this, no-invalid-this\n  const connection = this;\n  const deflatedLength = packet.readInt24();\n  const body = packet.readBuffer();\n\n  if (deflatedLength !== 0) {\n    connection.inflateQueue.push(task => {\n      zlib.inflate(body, (err, data) => {\n        if (err) {\n          connection._handleNetworkError(err);\n          return;\n        }\n        connection._bumpCompressedSequenceId(packet.numPackets);\n        connection._inflatedPacketsParser.execute(data);\n        task.done();\n      });\n    });\n  } else {\n    connection.inflateQueue.push(task => {\n      connection._bumpCompressedSequenceId(packet.numPackets);\n      connection._inflatedPacketsParser.execute(body);\n      task.done();\n    });\n  }\n}\n\nfunction writeCompressed(buffer) {\n  // http://dev.mysql.com/doc/internals/en/example-several-mysql-packets.html\n  // note: sending a MySQL Packet of the size 2^24−5 to 2^24−1 via compression\n  // leads to at least one extra compressed packet.\n  // (this is because \"length of the packet before compression\" need to fit\n  // into 3 byte unsigned int. \"length of the packet before compression\" includes\n  // 4 byte packet header, hence 2^24−5)\n  const MAX_COMPRESSED_LENGTH = 16777210;\n  let start;\n  if (buffer.length > MAX_COMPRESSED_LENGTH) {\n    for (start = 0; start < buffer.length; start += MAX_COMPRESSED_LENGTH) {\n      writeCompressed.call(\n        // eslint-disable-next-line no-invalid-this\n        this,\n        buffer.slice(start, start + MAX_COMPRESSED_LENGTH)\n      );\n    }\n    return;\n  }\n\n  // eslint-disable-next-line no-invalid-this, consistent-this\n  const connection = this;\n\n  let packetLen = buffer.length;\n  const compressHeader = Buffer.allocUnsafe(7);\n\n  // seqqueue is used here because zlib async execution is routed via thread pool\n  // internally and when we have multiple compressed packets arriving we need\n  // to assemble uncompressed result sequentially\n  (function(seqId) {\n    connection.deflateQueue.push(task => {\n      zlib.deflate(buffer, (err, compressed) => {\n        if (err) {\n          connection._handleFatalError(err);\n          return;\n        }\n        let compressedLength = compressed.length;\n\n        if (compressedLength < packetLen) {\n          compressHeader.writeUInt8(compressedLength & 0xff, 0);\n          compressHeader.writeUInt16LE(compressedLength >> 8, 1);\n          compressHeader.writeUInt8(seqId, 3);\n          compressHeader.writeUInt8(packetLen & 0xff, 4);\n          compressHeader.writeUInt16LE(packetLen >> 8, 5);\n          connection.writeUncompressed(compressHeader);\n          connection.writeUncompressed(compressed);\n        } else {\n          // http://dev.mysql.com/doc/internals/en/uncompressed-payload.html\n          // To send an uncompressed payload:\n          //   - set length of payload before compression to 0\n          //   - the compressed payload contains the uncompressed payload instead.\n          compressedLength = packetLen;\n          packetLen = 0;\n          compressHeader.writeUInt8(compressedLength & 0xff, 0);\n          compressHeader.writeUInt16LE(compressedLength >> 8, 1);\n          compressHeader.writeUInt8(seqId, 3);\n          compressHeader.writeUInt8(packetLen & 0xff, 4);\n          compressHeader.writeUInt16LE(packetLen >> 8, 5);\n          connection.writeUncompressed(compressHeader);\n          connection.writeUncompressed(buffer);\n        }\n        task.done();\n      });\n    });\n  })(connection.compressedSequenceId);\n  connection._bumpCompressedSequenceId(1);\n}\n\nfunction enableCompression(connection) {\n  connection._lastWrittenPacketId = 0;\n  connection._lastReceivedPacketId = 0;\n\n  connection._handleCompressedPacket = handleCompressedPacket;\n  connection._inflatedPacketsParser = new PacketParser(p => {\n    connection.handlePacket(p);\n  }, 4);\n  connection._inflatedPacketsParser._lastPacket = 0;\n  connection.packetParser = new PacketParser(packet => {\n    connection._handleCompressedPacket(packet);\n  }, 7);\n\n  connection.writeUncompressed = connection.write;\n  connection.write = writeCompressed;\n\n  const seqqueue = require('seq-queue');\n  connection.inflateQueue = seqqueue.createQueue();\n  connection.deflateQueue = seqqueue.createQueue();\n}\n\nmodule.exports = {\n  enableCompression: enableCompression\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}