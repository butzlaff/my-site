{"ast":null,"code":"'use strict';\n\nconst CommandCode = require('../constants/commands.js');\n\nconst Errors = require('../constants/errors.js');\n\nconst Command = require('./command.js');\n\nconst Packets = require('../packets/index.js');\n\nclass ServerHandshake extends Command {\n  constructor(args) {\n    super();\n    this.args = args;\n    /*\n    this.protocolVersion = args.protocolVersion || 10;\n    this.serverVersion   = args.serverVersion;\n    this.connectionId    = args.connectionId,\n    this.statusFlags     = args.statusFlags,\n    this.characterSet    = args.characterSet,\n    this.capabilityFlags = args.capabilityFlags || 512;\n    */\n  }\n\n  start(packet, connection) {\n    const serverHelloPacket = new Packets.Handshake(this.args);\n    this.serverHello = serverHelloPacket;\n    serverHelloPacket.setScrambleData(err => {\n      if (err) {\n        connection.emit('error', new Error('Error generating random bytes'));\n        return;\n      }\n\n      connection.writePacket(serverHelloPacket.toPacket(0));\n    });\n    return ServerHandshake.prototype.readClientReply;\n  }\n\n  readClientReply(packet, connection) {\n    // check auth here\n    const clientHelloReply = Packets.HandshakeResponse.fromPacket(packet); // TODO check we don't have something similar already\n\n    connection.clientHelloReply = clientHelloReply;\n\n    if (this.args.authCallback) {\n      this.args.authCallback({\n        user: clientHelloReply.user,\n        database: clientHelloReply.database,\n        address: connection.stream.remoteAddress,\n        authPluginData1: this.serverHello.authPluginData1,\n        authPluginData2: this.serverHello.authPluginData2,\n        authToken: clientHelloReply.authToken\n      }, (err, mysqlError) => {\n        // if (err)\n        if (!mysqlError) {\n          connection.writeOk();\n        } else {\n          // TODO create constants / errorToCode\n          // 1045 = ER_ACCESS_DENIED_ERROR\n          connection.writeError({\n            message: mysqlError.message || '',\n            code: mysqlError.code || 1045\n          });\n          connection.close();\n        }\n      });\n    } else {\n      connection.writeOk();\n    }\n\n    return ServerHandshake.prototype.dispatchCommands;\n  }\n\n  dispatchCommands(packet, connection) {\n    // command from client to server\n    let knownCommand = true;\n    const encoding = connection.clientHelloReply.encoding;\n    const commandCode = packet.readInt8();\n\n    switch (commandCode) {\n      case CommandCode.QUIT:\n        if (connection.listeners('quit').length) {\n          connection.emit('quit');\n        } else {\n          connection.stream.end();\n        }\n\n        break;\n\n      case CommandCode.INIT_DB:\n        if (connection.listeners('init_db').length) {\n          const schemaName = packet.readString(undefined, encoding);\n          connection.emit('init_db', schemaName);\n        } else {\n          connection.writeOk();\n        }\n\n        break;\n\n      case CommandCode.QUERY:\n        if (connection.listeners('query').length) {\n          const query = packet.readString(undefined, encoding);\n          connection.emit('query', query);\n        } else {\n          connection.writeError({\n            code: Errors.HA_ERR_INTERNAL_ERROR,\n            message: 'No query handler'\n          });\n        }\n\n        break;\n\n      case CommandCode.FIELD_LIST:\n        if (connection.listeners('field_list').length) {\n          const table = packet.readNullTerminatedString();\n          const fields = packet.readString(undefined, encoding);\n          connection.emit('field_list', table, fields);\n        } else {\n          connection.writeError({\n            code: Errors.ER_WARN_DEPRECATED_SYNTAX,\n            message: 'As of MySQL 5.7.11, COM_FIELD_LIST is deprecated and will be removed in a future version of MySQL.'\n          });\n        }\n\n        break;\n\n      case CommandCode.PING:\n        if (connection.listeners('ping').length) {\n          connection.emit('ping');\n        } else {\n          connection.writeOk();\n        }\n\n        break;\n\n      default:\n        knownCommand = false;\n    }\n\n    if (connection.listeners('packet').length) {\n      connection.emit('packet', packet.clone(), knownCommand, commandCode);\n    } else if (!knownCommand) {\n      // eslint-disable-next-line no-console\n      console.log('Unknown command:', commandCode);\n    }\n\n    return ServerHandshake.prototype.dispatchCommands;\n  }\n\n}\n\nmodule.exports = ServerHandshake; // TODO: implement server-side 4.1 authentication\n\n/*\n4.1 authentication: (http://bazaar.launchpad.net/~mysql/mysql-server/5.5/view/head:/sql/password.c)\n\n  SERVER:  public_seed=create_random_string()\n           send(public_seed)\n\n  CLIENT:  recv(public_seed)\n           hash_stage1=sha1(\"password\")\n           hash_stage2=sha1(hash_stage1)\n           reply=xor(hash_stage1, sha1(public_seed,hash_stage2)\n\n           // this three steps are done in scramble()\n\n           send(reply)\n\n\n  SERVER:  recv(reply)\n           hash_stage1=xor(reply, sha1(public_seed,hash_stage2))\n           candidate_hash2=sha1(hash_stage1)\n           check(candidate_hash2==hash_stage2)\n\nserver stores sha1(sha1(password)) ( hash_stag2)\n*/","map":{"version":3,"names":["CommandCode","require","Errors","Command","Packets","ServerHandshake","constructor","args","start","packet","connection","serverHelloPacket","Handshake","serverHello","setScrambleData","err","emit","Error","writePacket","toPacket","prototype","readClientReply","clientHelloReply","HandshakeResponse","fromPacket","authCallback","user","database","address","stream","remoteAddress","authPluginData1","authPluginData2","authToken","mysqlError","writeOk","writeError","message","code","close","dispatchCommands","knownCommand","encoding","commandCode","readInt8","QUIT","listeners","length","end","INIT_DB","schemaName","readString","undefined","QUERY","query","HA_ERR_INTERNAL_ERROR","FIELD_LIST","table","readNullTerminatedString","fields","ER_WARN_DEPRECATED_SYNTAX","PING","clone","console","log","module","exports"],"sources":["/home/emilio/Ãrea de Trabalho/OneBitCode-aulas/REACT/site-react-login-live/react-controlledForms/node_modules/mysql2/lib/commands/server_handshake.js"],"sourcesContent":["'use strict';\n\nconst CommandCode = require('../constants/commands.js');\nconst Errors = require('../constants/errors.js');\n\nconst Command = require('./command.js');\nconst Packets = require('../packets/index.js');\n\nclass ServerHandshake extends Command {\n  constructor(args) {\n    super();\n    this.args = args;\n    /*\n    this.protocolVersion = args.protocolVersion || 10;\n    this.serverVersion   = args.serverVersion;\n    this.connectionId    = args.connectionId,\n    this.statusFlags     = args.statusFlags,\n    this.characterSet    = args.characterSet,\n    this.capabilityFlags = args.capabilityFlags || 512;\n    */\n  }\n\n  start(packet, connection) {\n    const serverHelloPacket = new Packets.Handshake(this.args);\n    this.serverHello = serverHelloPacket;\n    serverHelloPacket.setScrambleData(err => {\n      if (err) {\n        connection.emit('error', new Error('Error generating random bytes'));\n        return;\n      }\n      connection.writePacket(serverHelloPacket.toPacket(0));\n    });\n    return ServerHandshake.prototype.readClientReply;\n  }\n\n  readClientReply(packet, connection) {\n    // check auth here\n    const clientHelloReply = Packets.HandshakeResponse.fromPacket(packet);\n    // TODO check we don't have something similar already\n    connection.clientHelloReply = clientHelloReply;\n    if (this.args.authCallback) {\n      this.args.authCallback(\n        {\n          user: clientHelloReply.user,\n          database: clientHelloReply.database,\n          address: connection.stream.remoteAddress,\n          authPluginData1: this.serverHello.authPluginData1,\n          authPluginData2: this.serverHello.authPluginData2,\n          authToken: clientHelloReply.authToken\n        },\n        (err, mysqlError) => {\n          // if (err)\n          if (!mysqlError) {\n            connection.writeOk();\n          } else {\n            // TODO create constants / errorToCode\n            // 1045 = ER_ACCESS_DENIED_ERROR\n            connection.writeError({\n              message: mysqlError.message || '',\n              code: mysqlError.code || 1045\n            });\n            connection.close();\n          }\n        }\n      );\n    } else {\n      connection.writeOk();\n    }\n    return ServerHandshake.prototype.dispatchCommands;\n  }\n\n  dispatchCommands(packet, connection) {\n    // command from client to server\n    let knownCommand = true;\n    const encoding = connection.clientHelloReply.encoding;\n    const commandCode = packet.readInt8();\n    switch (commandCode) {\n      case CommandCode.QUIT:\n        if (connection.listeners('quit').length) {\n          connection.emit('quit');\n        } else {\n          connection.stream.end();\n        }\n        break;\n      case CommandCode.INIT_DB:\n        if (connection.listeners('init_db').length) {\n          const schemaName = packet.readString(undefined, encoding);\n          connection.emit('init_db', schemaName);\n        } else {\n          connection.writeOk();\n        }\n        break;\n      case CommandCode.QUERY:\n        if (connection.listeners('query').length) {\n          const query = packet.readString(undefined, encoding);\n          connection.emit('query', query);\n        } else {\n          connection.writeError({\n            code: Errors.HA_ERR_INTERNAL_ERROR,\n            message: 'No query handler'\n          });\n        }\n        break;\n      case CommandCode.FIELD_LIST:\n        if (connection.listeners('field_list').length) {\n          const table = packet.readNullTerminatedString();\n          const fields = packet.readString(undefined, encoding);\n          connection.emit('field_list', table, fields);\n        } else {\n          connection.writeError({\n            code: Errors.ER_WARN_DEPRECATED_SYNTAX,\n            message:\n              'As of MySQL 5.7.11, COM_FIELD_LIST is deprecated and will be removed in a future version of MySQL.'\n          });\n        }\n        break;\n      case CommandCode.PING:\n        if (connection.listeners('ping').length) {\n          connection.emit('ping');\n        } else {\n          connection.writeOk();\n        }\n        break;\n      default:\n        knownCommand = false;\n    }\n    if (connection.listeners('packet').length) {\n      connection.emit('packet', packet.clone(), knownCommand, commandCode);\n    } else if (!knownCommand) {\n      // eslint-disable-next-line no-console\n      console.log('Unknown command:', commandCode);\n    }\n    return ServerHandshake.prototype.dispatchCommands;\n  }\n}\n\nmodule.exports = ServerHandshake;\n\n// TODO: implement server-side 4.1 authentication\n/*\n4.1 authentication: (http://bazaar.launchpad.net/~mysql/mysql-server/5.5/view/head:/sql/password.c)\n\n  SERVER:  public_seed=create_random_string()\n           send(public_seed)\n\n  CLIENT:  recv(public_seed)\n           hash_stage1=sha1(\"password\")\n           hash_stage2=sha1(hash_stage1)\n           reply=xor(hash_stage1, sha1(public_seed,hash_stage2)\n\n           // this three steps are done in scramble()\n\n           send(reply)\n\n\n  SERVER:  recv(reply)\n           hash_stage1=xor(reply, sha1(public_seed,hash_stage2))\n           candidate_hash2=sha1(hash_stage1)\n           check(candidate_hash2==hash_stage2)\n\nserver stores sha1(sha1(password)) ( hash_stag2)\n*/\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}