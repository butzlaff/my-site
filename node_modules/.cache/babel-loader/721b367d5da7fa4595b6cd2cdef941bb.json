{"ast":null,"code":"'use strict';\n\nconst ClientConstants = require('../constants/client.js');\n\nconst CharsetToEncoding = require('../constants/charset_encodings.js');\n\nconst Packet = require('../packets/packet.js');\n\nconst auth41 = require('../auth_41.js');\n\nclass HandshakeResponse {\n  constructor(handshake) {\n    this.user = handshake.user || '';\n    this.database = handshake.database || '';\n    this.password = handshake.password || '';\n    this.passwordSha1 = handshake.passwordSha1;\n    this.authPluginData1 = handshake.authPluginData1;\n    this.authPluginData2 = handshake.authPluginData2;\n    this.compress = handshake.compress;\n    this.clientFlags = handshake.flags; // TODO: pre-4.1 auth support\n\n    let authToken;\n\n    if (this.passwordSha1) {\n      authToken = auth41.calculateTokenFromPasswordSha(this.passwordSha1, this.authPluginData1, this.authPluginData2);\n    } else {\n      authToken = auth41.calculateToken(this.password, this.authPluginData1, this.authPluginData2);\n    }\n\n    this.authToken = authToken;\n    this.charsetNumber = handshake.charsetNumber;\n    this.encoding = CharsetToEncoding[handshake.charsetNumber];\n    this.connectAttributes = handshake.connectAttributes;\n  }\n\n  serializeResponse(buffer) {\n    const isSet = flag => this.clientFlags & ClientConstants[flag];\n\n    const packet = new Packet(0, buffer, 0, buffer.length);\n    packet.offset = 4;\n    packet.writeInt32(this.clientFlags);\n    packet.writeInt32(0); // max packet size. todo: move to config\n\n    packet.writeInt8(this.charsetNumber);\n    packet.skip(23);\n    const encoding = this.encoding;\n    packet.writeNullTerminatedString(this.user, encoding);\n    let k;\n\n    if (isSet('PLUGIN_AUTH_LENENC_CLIENT_DATA')) {\n      packet.writeLengthCodedNumber(this.authToken.length);\n      packet.writeBuffer(this.authToken);\n    } else if (isSet('SECURE_CONNECTION')) {\n      packet.writeInt8(this.authToken.length);\n      packet.writeBuffer(this.authToken);\n    } else {\n      packet.writeBuffer(this.authToken);\n      packet.writeInt8(0);\n    }\n\n    if (isSet('CONNECT_WITH_DB')) {\n      packet.writeNullTerminatedString(this.database, encoding);\n    }\n\n    if (isSet('PLUGIN_AUTH')) {\n      // TODO: pass from config\n      packet.writeNullTerminatedString('mysql_native_password', 'latin1');\n    }\n\n    if (isSet('CONNECT_ATTRS')) {\n      const connectAttributes = this.connectAttributes || {};\n      const attrNames = Object.keys(connectAttributes);\n      let keysLength = 0;\n\n      for (k = 0; k < attrNames.length; ++k) {\n        keysLength += Packet.lengthCodedStringLength(attrNames[k], encoding);\n        keysLength += Packet.lengthCodedStringLength(connectAttributes[attrNames[k]], encoding);\n      }\n\n      packet.writeLengthCodedNumber(keysLength);\n\n      for (k = 0; k < attrNames.length; ++k) {\n        packet.writeLengthCodedString(attrNames[k], encoding);\n        packet.writeLengthCodedString(connectAttributes[attrNames[k]], encoding);\n      }\n    }\n\n    return packet;\n  }\n\n  toPacket() {\n    if (typeof this.user !== 'string') {\n      throw new Error('\"user\" connection config property must be a string');\n    }\n\n    if (typeof this.database !== 'string') {\n      throw new Error('\"database\" connection config property must be a string');\n    } // dry run: calculate resulting packet length\n\n\n    const p = this.serializeResponse(Packet.MockBuffer());\n    return this.serializeResponse(Buffer.alloc(p.offset));\n  }\n\n  static fromPacket(packet) {\n    const args = {};\n    args.clientFlags = packet.readInt32();\n\n    function isSet(flag) {\n      return args.clientFlags & ClientConstants[flag];\n    }\n\n    args.maxPacketSize = packet.readInt32();\n    args.charsetNumber = packet.readInt8();\n    const encoding = CharsetToEncoding[args.charsetNumber];\n    args.encoding = encoding;\n    packet.skip(23);\n    args.user = packet.readNullTerminatedString(encoding);\n    let authTokenLength;\n\n    if (isSet('PLUGIN_AUTH_LENENC_CLIENT_DATA')) {\n      authTokenLength = packet.readLengthCodedNumber(encoding);\n      args.authToken = packet.readBuffer(authTokenLength);\n    } else if (isSet('SECURE_CONNECTION')) {\n      authTokenLength = packet.readInt8();\n      args.authToken = packet.readBuffer(authTokenLength);\n    } else {\n      args.authToken = packet.readNullTerminatedString(encoding);\n    }\n\n    if (isSet('CONNECT_WITH_DB')) {\n      args.database = packet.readNullTerminatedString(encoding);\n    }\n\n    if (isSet('PLUGIN_AUTH')) {\n      args.authPluginName = packet.readNullTerminatedString(encoding);\n    }\n\n    if (isSet('CONNECT_ATTRS')) {\n      const keysLength = packet.readLengthCodedNumber(encoding);\n      const keysEnd = packet.offset + keysLength;\n      const attrs = {};\n\n      while (packet.offset < keysEnd) {\n        attrs[packet.readLengthCodedString(encoding)] = packet.readLengthCodedString(encoding);\n      }\n\n      args.connectAttributes = attrs;\n    }\n\n    return args;\n  }\n\n}\n\nmodule.exports = HandshakeResponse;","map":{"version":3,"names":["ClientConstants","require","CharsetToEncoding","Packet","auth41","HandshakeResponse","constructor","handshake","user","database","password","passwordSha1","authPluginData1","authPluginData2","compress","clientFlags","flags","authToken","calculateTokenFromPasswordSha","calculateToken","charsetNumber","encoding","connectAttributes","serializeResponse","buffer","isSet","flag","packet","length","offset","writeInt32","writeInt8","skip","writeNullTerminatedString","k","writeLengthCodedNumber","writeBuffer","attrNames","Object","keys","keysLength","lengthCodedStringLength","writeLengthCodedString","toPacket","Error","p","MockBuffer","Buffer","alloc","fromPacket","args","readInt32","maxPacketSize","readInt8","readNullTerminatedString","authTokenLength","readLengthCodedNumber","readBuffer","authPluginName","keysEnd","attrs","readLengthCodedString","module","exports"],"sources":["/home/emilio/Ãrea de Trabalho/OneBitCode-aulas/REACT/site-react-login-live/react-controlledForms/node_modules/mysql2/lib/packets/handshake_response.js"],"sourcesContent":["'use strict';\n\nconst ClientConstants = require('../constants/client.js');\nconst CharsetToEncoding = require('../constants/charset_encodings.js');\nconst Packet = require('../packets/packet.js');\n\nconst auth41 = require('../auth_41.js');\n\nclass HandshakeResponse {\n  constructor(handshake) {\n    this.user = handshake.user || '';\n    this.database = handshake.database || '';\n    this.password = handshake.password || '';\n    this.passwordSha1 = handshake.passwordSha1;\n    this.authPluginData1 = handshake.authPluginData1;\n    this.authPluginData2 = handshake.authPluginData2;\n    this.compress = handshake.compress;\n    this.clientFlags = handshake.flags;\n    // TODO: pre-4.1 auth support\n    let authToken;\n    if (this.passwordSha1) {\n      authToken = auth41.calculateTokenFromPasswordSha(\n        this.passwordSha1,\n        this.authPluginData1,\n        this.authPluginData2\n      );\n    } else {\n      authToken = auth41.calculateToken(\n        this.password,\n        this.authPluginData1,\n        this.authPluginData2\n      );\n    }\n    this.authToken = authToken;\n    this.charsetNumber = handshake.charsetNumber;\n    this.encoding = CharsetToEncoding[handshake.charsetNumber];\n    this.connectAttributes = handshake.connectAttributes;\n  }\n\n  serializeResponse(buffer) {\n    const isSet = flag => this.clientFlags & ClientConstants[flag];\n    const packet = new Packet(0, buffer, 0, buffer.length);\n    packet.offset = 4;\n    packet.writeInt32(this.clientFlags);\n    packet.writeInt32(0); // max packet size. todo: move to config\n    packet.writeInt8(this.charsetNumber);\n    packet.skip(23);\n    const encoding = this.encoding;\n    packet.writeNullTerminatedString(this.user, encoding);\n    let k;\n    if (isSet('PLUGIN_AUTH_LENENC_CLIENT_DATA')) {\n      packet.writeLengthCodedNumber(this.authToken.length);\n      packet.writeBuffer(this.authToken);\n    } else if (isSet('SECURE_CONNECTION')) {\n      packet.writeInt8(this.authToken.length);\n      packet.writeBuffer(this.authToken);\n    } else {\n      packet.writeBuffer(this.authToken);\n      packet.writeInt8(0);\n    }\n    if (isSet('CONNECT_WITH_DB')) {\n      packet.writeNullTerminatedString(this.database, encoding);\n    }\n    if (isSet('PLUGIN_AUTH')) {\n      // TODO: pass from config\n      packet.writeNullTerminatedString('mysql_native_password', 'latin1');\n    }\n    if (isSet('CONNECT_ATTRS')) {\n      const connectAttributes = this.connectAttributes || {};\n      const attrNames = Object.keys(connectAttributes);\n      let keysLength = 0;\n      for (k = 0; k < attrNames.length; ++k) {\n        keysLength += Packet.lengthCodedStringLength(attrNames[k], encoding);\n        keysLength += Packet.lengthCodedStringLength(\n          connectAttributes[attrNames[k]],\n          encoding\n        );\n      }\n      packet.writeLengthCodedNumber(keysLength);\n      for (k = 0; k < attrNames.length; ++k) {\n        packet.writeLengthCodedString(attrNames[k], encoding);\n        packet.writeLengthCodedString(\n          connectAttributes[attrNames[k]],\n          encoding\n        );\n      }\n    }\n    return packet;\n  }\n\n  toPacket() {\n    if (typeof this.user !== 'string') {\n      throw new Error('\"user\" connection config property must be a string');\n    }\n    if (typeof this.database !== 'string') {\n      throw new Error('\"database\" connection config property must be a string');\n    }\n    // dry run: calculate resulting packet length\n    const p = this.serializeResponse(Packet.MockBuffer());\n    return this.serializeResponse(Buffer.alloc(p.offset));\n  }\n  static fromPacket(packet) {\n    const args = {};\n    args.clientFlags = packet.readInt32();\n    function isSet(flag) {\n      return args.clientFlags & ClientConstants[flag];\n    }\n    args.maxPacketSize = packet.readInt32();\n    args.charsetNumber = packet.readInt8();\n    const encoding = CharsetToEncoding[args.charsetNumber];\n    args.encoding = encoding;\n    packet.skip(23);\n    args.user = packet.readNullTerminatedString(encoding);\n    let authTokenLength;\n    if (isSet('PLUGIN_AUTH_LENENC_CLIENT_DATA')) {\n      authTokenLength = packet.readLengthCodedNumber(encoding);\n      args.authToken = packet.readBuffer(authTokenLength);\n    } else if (isSet('SECURE_CONNECTION')) {\n      authTokenLength = packet.readInt8();\n      args.authToken = packet.readBuffer(authTokenLength);\n    } else {\n      args.authToken = packet.readNullTerminatedString(encoding);\n    }\n    if (isSet('CONNECT_WITH_DB')) {\n      args.database = packet.readNullTerminatedString(encoding);\n    }\n    if (isSet('PLUGIN_AUTH')) {\n      args.authPluginName = packet.readNullTerminatedString(encoding);\n    }\n    if (isSet('CONNECT_ATTRS')) {\n      const keysLength = packet.readLengthCodedNumber(encoding);\n      const keysEnd = packet.offset + keysLength;\n      const attrs = {};\n      while (packet.offset < keysEnd) {\n        attrs[\n          packet.readLengthCodedString(encoding)\n        ] = packet.readLengthCodedString(encoding);\n      }\n      args.connectAttributes = attrs;\n    }\n    return args;\n  }\n}\n\nmodule.exports = HandshakeResponse;\n"],"mappings":"AAAA;;AAEA,MAAMA,eAAe,GAAGC,OAAO,CAAC,wBAAD,CAA/B;;AACA,MAAMC,iBAAiB,GAAGD,OAAO,CAAC,mCAAD,CAAjC;;AACA,MAAME,MAAM,GAAGF,OAAO,CAAC,sBAAD,CAAtB;;AAEA,MAAMG,MAAM,GAAGH,OAAO,CAAC,eAAD,CAAtB;;AAEA,MAAMI,iBAAN,CAAwB;EACtBC,WAAW,CAACC,SAAD,EAAY;IACrB,KAAKC,IAAL,GAAYD,SAAS,CAACC,IAAV,IAAkB,EAA9B;IACA,KAAKC,QAAL,GAAgBF,SAAS,CAACE,QAAV,IAAsB,EAAtC;IACA,KAAKC,QAAL,GAAgBH,SAAS,CAACG,QAAV,IAAsB,EAAtC;IACA,KAAKC,YAAL,GAAoBJ,SAAS,CAACI,YAA9B;IACA,KAAKC,eAAL,GAAuBL,SAAS,CAACK,eAAjC;IACA,KAAKC,eAAL,GAAuBN,SAAS,CAACM,eAAjC;IACA,KAAKC,QAAL,GAAgBP,SAAS,CAACO,QAA1B;IACA,KAAKC,WAAL,GAAmBR,SAAS,CAACS,KAA7B,CARqB,CASrB;;IACA,IAAIC,SAAJ;;IACA,IAAI,KAAKN,YAAT,EAAuB;MACrBM,SAAS,GAAGb,MAAM,CAACc,6BAAP,CACV,KAAKP,YADK,EAEV,KAAKC,eAFK,EAGV,KAAKC,eAHK,CAAZ;IAKD,CAND,MAMO;MACLI,SAAS,GAAGb,MAAM,CAACe,cAAP,CACV,KAAKT,QADK,EAEV,KAAKE,eAFK,EAGV,KAAKC,eAHK,CAAZ;IAKD;;IACD,KAAKI,SAAL,GAAiBA,SAAjB;IACA,KAAKG,aAAL,GAAqBb,SAAS,CAACa,aAA/B;IACA,KAAKC,QAAL,GAAgBnB,iBAAiB,CAACK,SAAS,CAACa,aAAX,CAAjC;IACA,KAAKE,iBAAL,GAAyBf,SAAS,CAACe,iBAAnC;EACD;;EAEDC,iBAAiB,CAACC,MAAD,EAAS;IACxB,MAAMC,KAAK,GAAGC,IAAI,IAAI,KAAKX,WAAL,GAAmBf,eAAe,CAAC0B,IAAD,CAAxD;;IACA,MAAMC,MAAM,GAAG,IAAIxB,MAAJ,CAAW,CAAX,EAAcqB,MAAd,EAAsB,CAAtB,EAAyBA,MAAM,CAACI,MAAhC,CAAf;IACAD,MAAM,CAACE,MAAP,GAAgB,CAAhB;IACAF,MAAM,CAACG,UAAP,CAAkB,KAAKf,WAAvB;IACAY,MAAM,CAACG,UAAP,CAAkB,CAAlB,EALwB,CAKF;;IACtBH,MAAM,CAACI,SAAP,CAAiB,KAAKX,aAAtB;IACAO,MAAM,CAACK,IAAP,CAAY,EAAZ;IACA,MAAMX,QAAQ,GAAG,KAAKA,QAAtB;IACAM,MAAM,CAACM,yBAAP,CAAiC,KAAKzB,IAAtC,EAA4Ca,QAA5C;IACA,IAAIa,CAAJ;;IACA,IAAIT,KAAK,CAAC,gCAAD,CAAT,EAA6C;MAC3CE,MAAM,CAACQ,sBAAP,CAA8B,KAAKlB,SAAL,CAAeW,MAA7C;MACAD,MAAM,CAACS,WAAP,CAAmB,KAAKnB,SAAxB;IACD,CAHD,MAGO,IAAIQ,KAAK,CAAC,mBAAD,CAAT,EAAgC;MACrCE,MAAM,CAACI,SAAP,CAAiB,KAAKd,SAAL,CAAeW,MAAhC;MACAD,MAAM,CAACS,WAAP,CAAmB,KAAKnB,SAAxB;IACD,CAHM,MAGA;MACLU,MAAM,CAACS,WAAP,CAAmB,KAAKnB,SAAxB;MACAU,MAAM,CAACI,SAAP,CAAiB,CAAjB;IACD;;IACD,IAAIN,KAAK,CAAC,iBAAD,CAAT,EAA8B;MAC5BE,MAAM,CAACM,yBAAP,CAAiC,KAAKxB,QAAtC,EAAgDY,QAAhD;IACD;;IACD,IAAII,KAAK,CAAC,aAAD,CAAT,EAA0B;MACxB;MACAE,MAAM,CAACM,yBAAP,CAAiC,uBAAjC,EAA0D,QAA1D;IACD;;IACD,IAAIR,KAAK,CAAC,eAAD,CAAT,EAA4B;MAC1B,MAAMH,iBAAiB,GAAG,KAAKA,iBAAL,IAA0B,EAApD;MACA,MAAMe,SAAS,GAAGC,MAAM,CAACC,IAAP,CAAYjB,iBAAZ,CAAlB;MACA,IAAIkB,UAAU,GAAG,CAAjB;;MACA,KAAKN,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGG,SAAS,CAACT,MAA1B,EAAkC,EAAEM,CAApC,EAAuC;QACrCM,UAAU,IAAIrC,MAAM,CAACsC,uBAAP,CAA+BJ,SAAS,CAACH,CAAD,CAAxC,EAA6Cb,QAA7C,CAAd;QACAmB,UAAU,IAAIrC,MAAM,CAACsC,uBAAP,CACZnB,iBAAiB,CAACe,SAAS,CAACH,CAAD,CAAV,CADL,EAEZb,QAFY,CAAd;MAID;;MACDM,MAAM,CAACQ,sBAAP,CAA8BK,UAA9B;;MACA,KAAKN,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGG,SAAS,CAACT,MAA1B,EAAkC,EAAEM,CAApC,EAAuC;QACrCP,MAAM,CAACe,sBAAP,CAA8BL,SAAS,CAACH,CAAD,CAAvC,EAA4Cb,QAA5C;QACAM,MAAM,CAACe,sBAAP,CACEpB,iBAAiB,CAACe,SAAS,CAACH,CAAD,CAAV,CADnB,EAEEb,QAFF;MAID;IACF;;IACD,OAAOM,MAAP;EACD;;EAEDgB,QAAQ,GAAG;IACT,IAAI,OAAO,KAAKnC,IAAZ,KAAqB,QAAzB,EAAmC;MACjC,MAAM,IAAIoC,KAAJ,CAAU,oDAAV,CAAN;IACD;;IACD,IAAI,OAAO,KAAKnC,QAAZ,KAAyB,QAA7B,EAAuC;MACrC,MAAM,IAAImC,KAAJ,CAAU,wDAAV,CAAN;IACD,CANQ,CAOT;;;IACA,MAAMC,CAAC,GAAG,KAAKtB,iBAAL,CAAuBpB,MAAM,CAAC2C,UAAP,EAAvB,CAAV;IACA,OAAO,KAAKvB,iBAAL,CAAuBwB,MAAM,CAACC,KAAP,CAAaH,CAAC,CAAChB,MAAf,CAAvB,CAAP;EACD;;EACgB,OAAVoB,UAAU,CAACtB,MAAD,EAAS;IACxB,MAAMuB,IAAI,GAAG,EAAb;IACAA,IAAI,CAACnC,WAAL,GAAmBY,MAAM,CAACwB,SAAP,EAAnB;;IACA,SAAS1B,KAAT,CAAeC,IAAf,EAAqB;MACnB,OAAOwB,IAAI,CAACnC,WAAL,GAAmBf,eAAe,CAAC0B,IAAD,CAAzC;IACD;;IACDwB,IAAI,CAACE,aAAL,GAAqBzB,MAAM,CAACwB,SAAP,EAArB;IACAD,IAAI,CAAC9B,aAAL,GAAqBO,MAAM,CAAC0B,QAAP,EAArB;IACA,MAAMhC,QAAQ,GAAGnB,iBAAiB,CAACgD,IAAI,CAAC9B,aAAN,CAAlC;IACA8B,IAAI,CAAC7B,QAAL,GAAgBA,QAAhB;IACAM,MAAM,CAACK,IAAP,CAAY,EAAZ;IACAkB,IAAI,CAAC1C,IAAL,GAAYmB,MAAM,CAAC2B,wBAAP,CAAgCjC,QAAhC,CAAZ;IACA,IAAIkC,eAAJ;;IACA,IAAI9B,KAAK,CAAC,gCAAD,CAAT,EAA6C;MAC3C8B,eAAe,GAAG5B,MAAM,CAAC6B,qBAAP,CAA6BnC,QAA7B,CAAlB;MACA6B,IAAI,CAACjC,SAAL,GAAiBU,MAAM,CAAC8B,UAAP,CAAkBF,eAAlB,CAAjB;IACD,CAHD,MAGO,IAAI9B,KAAK,CAAC,mBAAD,CAAT,EAAgC;MACrC8B,eAAe,GAAG5B,MAAM,CAAC0B,QAAP,EAAlB;MACAH,IAAI,CAACjC,SAAL,GAAiBU,MAAM,CAAC8B,UAAP,CAAkBF,eAAlB,CAAjB;IACD,CAHM,MAGA;MACLL,IAAI,CAACjC,SAAL,GAAiBU,MAAM,CAAC2B,wBAAP,CAAgCjC,QAAhC,CAAjB;IACD;;IACD,IAAII,KAAK,CAAC,iBAAD,CAAT,EAA8B;MAC5ByB,IAAI,CAACzC,QAAL,GAAgBkB,MAAM,CAAC2B,wBAAP,CAAgCjC,QAAhC,CAAhB;IACD;;IACD,IAAII,KAAK,CAAC,aAAD,CAAT,EAA0B;MACxByB,IAAI,CAACQ,cAAL,GAAsB/B,MAAM,CAAC2B,wBAAP,CAAgCjC,QAAhC,CAAtB;IACD;;IACD,IAAII,KAAK,CAAC,eAAD,CAAT,EAA4B;MAC1B,MAAMe,UAAU,GAAGb,MAAM,CAAC6B,qBAAP,CAA6BnC,QAA7B,CAAnB;MACA,MAAMsC,OAAO,GAAGhC,MAAM,CAACE,MAAP,GAAgBW,UAAhC;MACA,MAAMoB,KAAK,GAAG,EAAd;;MACA,OAAOjC,MAAM,CAACE,MAAP,GAAgB8B,OAAvB,EAAgC;QAC9BC,KAAK,CACHjC,MAAM,CAACkC,qBAAP,CAA6BxC,QAA7B,CADG,CAAL,GAEIM,MAAM,CAACkC,qBAAP,CAA6BxC,QAA7B,CAFJ;MAGD;;MACD6B,IAAI,CAAC5B,iBAAL,GAAyBsC,KAAzB;IACD;;IACD,OAAOV,IAAP;EACD;;AArIqB;;AAwIxBY,MAAM,CAACC,OAAP,GAAiB1D,iBAAjB"},"metadata":{},"sourceType":"script"}